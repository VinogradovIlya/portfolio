-- Упражнение 05: Аномалия фантомных чтений (Phantom Reads)
-- Демонстрация под уровнем изоляции READ COMMITTED

-- Проверяем текущий уровень изоляции (должен быть READ COMMITTED)
SHOW TRANSACTION ISOLATION LEVEL;

-- ========== СЕССИЯ #1 ==========
-- Шаг 1: Начинаем транзакцию
BEGIN;

-- Шаг 2: ПЕРВОЕ агрегирование - суммируем все рейтинги всех пиццерий
SELECT SUM(rating) FROM pizzeria;
-- Записываем результат (например, 21.9)

-- ========== СЕССИЯ #2 ==========
-- Шаг 1: Начинаем отдельную транзакцию
BEGIN;

-- Шаг 2: Вставляем НОВУЮ пиццерию 'Kazan Pizza' с рейтингом 5 и ID=10
INSERT INTO pizzeria (id, name, rating) 
VALUES (10, 'Kazan Pizza', 5);

-- Шаг 3: Фиксируем изменения
COMMIT;

-- ========== СЕССИЯ #1 ==========
-- Шаг 3: ВТОРОЕ агрегирование в той же транзакции
SELECT SUM(rating) FROM pizzeria;
-- Результат ИЗМЕНИЛСЯ! (например, стал 26.9)
-- Появилась "фантомная" строка, которой не было при первом чтении

-- Дополнительно: проверим количество строк
SELECT COUNT(*) FROM pizzeria;
-- Количество пиццерий увеличилось!

-- Шаг 4: Фиксируем транзакцию
COMMIT;