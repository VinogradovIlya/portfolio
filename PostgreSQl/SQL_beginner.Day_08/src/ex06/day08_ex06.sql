-- Упражнение 06: Фантомные чтения для уровня REPEATABLE READ
-- Демонстрация как REPEATABLE READ предотвращает аномалию Phantom Reads

-- ========== СЕССИЯ #1 ==========
-- Шаг 1: Устанавливаем уровень изоляции REPEATABLE READ и начинаем транзакцию
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- Шаг 2: ПЕРВОЕ агрегирование - суммируем все рейтинги всех пиццерий
SELECT SUM(rating) FROM pizzeria;
-- Записываем результат (например, 26.9 после предыдущего упражнения)

-- ========== СЕССИЯ #2 ==========
-- Шаг 1: Начинаем отдельную транзакцию
BEGIN;

-- Шаг 2: Вставляем НОВУЮ пиццерию 'Kazan Pizza 2' с рейтингом 4 и ID=11
INSERT INTO pizzeria (id, name, rating) 
VALUES (11, 'Kazan Pizza 2', 4);

-- Шаг 3: Фиксируем изменения
COMMIT;

-- ========== СЕССИЯ #1 ==========
-- Шаг 3: ВТОРОЕ агрегирование в той же транзакции
SELECT SUM(rating) FROM pizzeria;
-- ВАЖНО: Результат будет ТОТ ЖЕ! (например, 26.9)
-- REPEATABLE READ не видит новые строки, добавленные другими транзакциями

-- Дополнительно: проверим количество строк
SELECT COUNT(*) FROM pizzeria;
-- Количество пиццерий НЕ изменилось в рамках нашей транзакции!

-- Шаг 4: Фиксируем транзакцию
COMMIT;

-- Финальная проверка после COMMIT:
SELECT SUM(rating) FROM pizzeria;
-- Теперь видим обновленную сумму с новой пиццерией (30.9)

SELECT * FROM pizzeria WHERE name = 'Kazan Pizza 2';
-- Теперь видим новую пиццерию