{% extends 'frontend/base.html' %}

{% block title %}Редактировать {{ pet.name }} - Pet Social Network{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <div class="form form--wide">
        <h1 class="text-center mb-4">Редактировать {{ pet.name }}</h1>
        
        <form method="post" enctype="multipart/form-data" id="pet-form">
            {% csrf_token %}
            
            <div class="grid grid--2">
                <div class="form__group">
                    <label for="name" class="form__label">Кличка *</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="form__input" 
                        required
                        placeholder="Барсик"
                        value="{{ pet.name }}"
                    >
                </div>
                
                <div class="form__group">
                    <label for="species" class="form__label">Вид животного *</label>
                    <select id="species" name="species" class="form__select" required>
                        <option value="">Выберите вид</option>
                        <option value="dog" {% if pet.breed.species == 'dog' %}selected{% endif %}>Собака</option>
                        <option value="cat" {% if pet.breed.species == 'cat' %}selected{% endif %}>Кошка</option>
                        <option value="bird" {% if pet.breed.species == 'bird' %}selected{% endif %}>Птица</option>
                        <option value="fish" {% if pet.breed.species == 'fish' %}selected{% endif %}>Рыба</option>
                        <option value="rodent" {% if pet.breed.species == 'rodent' %}selected{% endif %}>Грызун</option>
                        <option value="reptile" {% if pet.breed.species == 'reptile' %}selected{% endif %}>Рептилия</option>
                        <option value="other" {% if pet.breed.species == 'other' %}selected{% endif %}>Другое</option>
                    </select>
                </div>
            </div>
            
            <div class="form__group">
                <label for="breed" class="form__label">Порода *</label>
                <select id="breed" name="breed" class="form__select" required>
                    <option value="{{ pet.breed.id }}" selected>{{ pet.breed.name }}</option>
                </select>
            </div>
            
            <div class="grid grid--2">
                <div class="form__group">
                    <label for="birthday" class="form__label">Дата рождения *</label>
                    <input 
                        type="date" 
                        id="birthday" 
                        name="birthday" 
                        class="form__input" 
                        required
                        value="{{ pet.birthday|date:'Y-m-d' }}"
                    >
                </div>
                
                <div class="form__group">
                    <label for="gender" class="form__label">Пол</label>
                    <select id="gender" name="gender" class="form__select">
                        <option value="unknown" {% if pet.gender == 'unknown' %}selected{% endif %}>Не известно</option>
                        <option value="m" {% if pet.gender == 'm' %}selected{% endif %}>Мужской</option>
                        <option value="f" {% if pet.gender == 'f' %}selected{% endif %}>Женский</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid--2">
                <div class="form__group">
                    <label for="color" class="form__label">Окрас</label>
                    <select id="color" name="color" class="form__select">
                        <option value="">Выберите окрас</option>
                        <option value="white" {% if pet.color == 'white' %}selected{% endif %}>Белый</option>
                        <option value="black" {% if pet.color == 'black' %}selected{% endif %}>Черный</option>
                        <option value="grey" {% if pet.color == 'grey' %}selected{% endif %}>Серый</option>
                        <option value="brown" {% if pet.color == 'brown' %}selected{% endif %}>Коричневый</option>
                        <option value="red" {% if pet.color == 'red' %}selected{% endif %}>Рыжий</option>
                        <option value="multi" {% if pet.color == 'multi' %}selected{% endif %}>Разноцветный</option>
                        <option value="other" {% if pet.color == 'other' %}selected{% endif %}>Другой</option>
                    </select>
                </div>
                
                <div class="form__group">
                    <label for="weight" class="form__label">Вес (кг)</label>
                    <input 
                        type="number" 
                        id="weight" 
                        name="weight" 
                        class="form__input" 
                        step="0.1"
                        min="0"
                        placeholder="5.5"
                        value="{{ pet.weight }}"
                    >
                </div>
            </div>
            
            <div class="grid grid--2">
                <div class="form__group">
                    <label for="passport_number" class="form__label">Номер паспорта</label>
                    <input 
                        type="text" 
                        id="passport_number" 
                        name="passport_number" 
                        class="form__input" 
                        placeholder="ABC123456"
                        value="{{ pet.passport_number }}"
                    >
                </div>
                
                <div class="form__group">
                    <label for="chip_number" class="form__label">Номер чипа</label>
                    <input 
                        type="text" 
                        id="chip_number" 
                        name="chip_number" 
                        class="form__input" 
                        placeholder="123456789012345"
                        value="{{ pet.chip_number }}"
                    >
                </div>
            </div>
            
            <div class="form__group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="is_chipped" value="1" 
                           {% if pet.is_chipped %}checked{% endif %}>
                    Питомец чипирован
                </label>
            </div>
            
            {% if pet.main_photo %}
            <div class="form__group">
                <label class="form__label">Текущая фотография</label>
                <img src="{{ pet.main_photo.url }}" alt="{{ pet.name }}" 
                     style="max-width: 200px; border-radius: var(--radius);">
            </div>
            {% endif %}
            
            <div class="form__group">
                <label for="main_photo" class="form__label">
                    {% if pet.main_photo %}Изменить фотографию{% else %}Добавить фотографию{% endif %}
                </label>
                <input 
                    type="file" 
                    id="main_photo" 
                    name="main_photo" 
                    class="form__input" 
                    accept="image/*"
                >
            </div>
            
            <div class="form__group">
                <label for="description" class="form__label">Описание</label>
                <textarea 
                    id="description" 
                    name="description" 
                    class="form__textarea"
                    rows="3"
                    placeholder="Расскажите о характере питомца..."
                >{{ pet.description }}</textarea>
            </div>
            
            <div class="form__group">
                <label for="special_needs" class="form__label">Особые потребности</label>
                <textarea 
                    id="special_needs" 
                    name="special_needs" 
                    class="form__textarea"
                    rows="3"
                    placeholder="Аллергии, особенности ухода..."
                >{{ pet.special_needs }}</textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-primary">
                    Сохранить изменения
                </button>
                <a href="{% url 'frontend:pets_list' %}" class="btn btn-secondary">
                    Отмена
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const speciesSelect = document.getElementById('species');
    const breedSelect = document.getElementById('breed');
    const currentBreedId = {{ pet.breed.id }};
    
    speciesSelect.addEventListener('change', function() {
        const selectedSpecies = this.value;
        
        // Очищаем список пород
        breedSelect.innerHTML = '<option value="">Загрузка...</option>';
        breedSelect.disabled = true;
        
        if (selectedSpecies) {
            // Получаем породы с сервера через AJAX
            fetch(`{% url 'frontend:get_breeds' %}?species=${selectedSpecies}`)
                .then(response => response.json())
                .then(data => {
                    breedSelect.innerHTML = '';
                    
                    // Добавляем пустой вариант
                    const emptyOption = document.createElement('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'Выберите породу';
                    breedSelect.appendChild(emptyOption);
                    
                    // Добавляем породы
                    data.breeds.forEach(breed => {
                        const option = document.createElement('option');
                        option.value = breed.id;
                        option.textContent = breed.name;
                        // Выбираем текущую породу
                        if (breed.id === currentBreedId) {
                            option.selected = true;
                        }
                        breedSelect.appendChild(option);
                    });
                    
                    breedSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Ошибка загрузки пород:', error);
                    breedSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
                });
        } else {
            // Если вид не выбран
            breedSelect.innerHTML = '<option value="">Сначала выберите вид животного</option>';
            breedSelect.disabled = true;
        }
    });
    
    // Загружаем породы для текущего вида при загрузке страницы
    if (speciesSelect.value) {
        speciesSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}